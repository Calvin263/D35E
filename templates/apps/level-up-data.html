<form autocomplete="off" onsubmit="event.preventDefault();">
    <div class="header">

        <h1>{{localize "D35E.LUDLevelDetails"}} {{level}}</h1>
    </div>

    <h2 class="block-header">{{localize "D35E.Class"}}</h2>
    <p></p>
       <div class="flexcol" style="padding: 5px">
            <div class="form-group spellcasting-class tooltip flexrow">
                <label><span>{{localize "D35E.Class"}}</span></label>
                <select name="class" id="class-select" data-dtype="String" onchange="selectedClassData(this)">
                    <option data-hd="0" data-skill="0" data-weaponskill="0" value="">{{localize "D35E.SelectClass"}}</option>
                    {{#select levelUpData.classId}}
                    {{#each classes as |cls a|}}
                    <option data-hd="{{cls.data.hd}}" data-skill="{{cls.data.skillsPerLevel}}" data-weaponskill="{{cls.data.weaponskillsPerLevel}}" value="{{cls._id}}">{{cls.name}}</option>
                    {{/each}}
                    {{/select}}
                </select>
            </div>
      </div>
    <h2 class="block-header">{{localize "D35E.HitPoints"}}</h2>
    <p></p>
    <div class="flexcol" style="padding: 5px">
        <p>{{localize "D35E.LUDClassHD"}} <strong id="class-hd">0</strong></p>
        <div class="form-group spellcasting-class tooltip flexrow">
            <label><span>{{localize "D35E.HitPoints"}}</span></label>
            <input type="text" name="hp" id="hp-input" data-dtype="number" value="{{levelUpData.hp}}">
            <a onclick="rollHP()" class="btn roll-hp">{{localize "D35E.LUDRollHp"}}</a>

        </div>
    </div>
    <h2 class="block-header">{{localize "D35E.Skills"}}</h2>
    <p>{{{localize "D35E.LUDSkillsDesc"}}} </p>
    <p>{{localize "D35E.LUDSkillRank"}} <strong>{{maxSkillRank}}</strong> ({{localize "D35E._Level"}} {{totalLevel}} + 3)</p>
    {{{localize "D35E.LUDSkillPointsAtLevel"}}}
    <div class="flexrow">
        <div class="flexcol">
            <ul class="skills-list sub-scroll scroll-skillset flexrow" style="padding: 0">
            {{#each skillset as |skill s|}}
            {{#if skill.arbitrary}}
                {{#each skill.subSkills as |subSkill b|}}
                <li class="skill flexrow" data-skill="{{s}}.{{b}}">
                    <span  data-class-skillid="{{s}}">{{skill.label}} - {{subSkill.name}}{{#if skill.rt}}■{{/if}}</span>
                    <a class="item-control" title="Remove Skill Point" onclick="addRemoveSkill('skills.{{s}}.subSkills.{{b}}.rank','skills.{{s}}.subSkills.{{b}}.combinedRank',-1,{{subSkill.cs}})">
                        <i class="fas fa-minus remove-skill"></i>
                    </a>
                    <input type="text" class="skill-value" name="skills.{{s}}.subSkills.{{b}}.rank" value="{{subSkill.rank}}" readonly style="border: none" placeholder="0"/>
                    <input type="hidden" class="skill-class" data-class-skillid="{{s}}" value="{{subSkill.cs}}" readonly placeholder="0"/>
                    <a class="item-control" title="Add Skill Point" onclick="addRemoveSkill('skills.{{s}}.subSkills.{{b}}.rank','skills.{{s}}.subSkills.{{b}}.combinedRank',1,{{subSkill.cs}})">
                        <i class="fas fa-plus add-skill"></i>
                    </a>


                    <input type="hidden" class="original-skill-value"  value="{{subSkill.baseRank}}" readonly placeholder="0" style=""/>
                    <input type="text" class="combined-skill-value" value="{{subSkill.baseRank}}" disabled placeholder="0" style="border: none; flex: 0 25px"/>
                </li>

                {{/each}}
            {{else}}
            <li class="skill flexrow skillCount" data-skill="{{s}}">
                <div class="skill-row">
                    <div class="skill-row-left">
                        {{#if skill.custom}}
                        <span data-class-skillid="{{s}}">{{skill.name}}{{#if skill.rt}}■{{/if}}</span>
                        {{else}}
                        <span data-class-skillid="{{s}}">{{skill.label}}{{#if skill.rt}}■{{/if}}</span>
                        {{/if}}
                    </div>
                    <div class="skill-row-right">
                        <a class="item-control" title="Remove Skill Point" onclick="addRemoveSkill('skills.{{s}}.rank','skills.{{s}}.combinedRank',-1,{{skill.cs}})">
                            <i class="fas fa-minus remove-skill"></i>
                        </a>
                        <input type="text" class="skill-value" name="skills.{{s}}.rank" style="border: none" value="{{skill.rank}}" readonly placeholder="0"/>
                        <input type="hidden" class="skill-class" data-class-skillid="{{s}}" value="{{skill.cs}}" readonly placeholder="0"/>
                        <a class="item-control" title="Add Skill Point" onclick="addRemoveSkill('skills.{{s}}.rank','skills.{{s}}.combinedRank',1,{{skill.cs}})">
                            <i class="fas fa-plus add-skill"></i>
                        </a>

                        <input type="hidden" class="original-skill-value" value="{{skill.baseRank}}" readonly placeholder="0" style="flex: 0 25px"/>
                        <input type="text" class="combined-skill-value" name="skills.{{s}}.combinedRank" value="{{skill.baseRank}}" disabled placeholder="0" style="border: none; flex: 0 25px"/>
                    </div>
                </div>
                <!-- NEW Level & Progression -->
                <div class="skill-row-2">
                    <div class="flewrow skill-level">
                        <label class="skill-level-label">{{skill.level}}</label>
                    </div>
                    <div class="flewrow">
                        <label class="skill-progression-label">{{skill.progression}}</label>
                    </div>
                </div>
                <!-- END NEW -->
            </li>
            {{/if}}
            {{/each}}
            </ul>
        </div>
    </div>

    <!-- NEW -->
    <h2 class="block-header">{{localize "D35E.WeaponSkills"}}</h2>
    <p>{{{localize "D35E.LUDWeaponSkillsDesc"}}} </p>
    <p>{{localize "D35E.LUDSkillRank"}} <strong>{{maxWeaponSkillRank}}</strong> ({{localize "D35E._Level"}} {{totalLevel}} + 3)</p>
    {{{localize "D35E.LUDWeaponSkillPointsAtLevel"}}}
    <div class="flexrow">
        <div class="flexcol">
            <ul class="skills-list sub-scroll scroll-skillset flexrow" style="padding: 0">
            {{#each weaponSkillset as |skill s|}}
            <li class="skill flexrow weaponskillCount" data-weaponskill="{{s}}">
                <div class="skill-row">
                    <div class="skill-row-left">
                        <span data-class-skillid="{{s}}">{{skill.label}}{{#if skill.rt}}■{{/if}}</span>
                    </div>
                    <div class="skill-row-right">
                        <a class="item-control" title="Remove Skill Point" onclick="addRemoveWeaponSkill('weaponSkill.{{s}}.rank','weaponSkill.{{s}}.combinedRank',-1,{{skill.cs}})">
                            <i class="fas fa-minus remove-skill"></i>
                        </a>
                        <input type="text" class="skill-value" name="weaponSkill.{{s}}.rank" style="border: none" value="{{skill.rank}}" readonly placeholder="0"/>
                        <input type="hidden" class="skill-class" data-class-skillid="{{s}}" value="{{skill.cs}}" readonly placeholder="0"/>
                        <a class="item-control" title="Add Skill Point" onclick="addRemoveWeaponSkill('weaponSkill.{{s}}.rank','weaponSkill.{{s}}.combinedRank',1,{{skill.cs}})">
                            <i class="fas fa-plus add-skill"></i>
                        </a>

                        <input type="hidden" class="original-skill-value" value="{{skill.baseRank}}" readonly placeholder="0" style="flex: 0 25px"/>
                        <input type="text" class="combined-skill-value" name="weaponSkill.{{s}}.combinedRank" value="{{skill.baseRank}}" disabled placeholder="0" style="border: none; flex: 0 25px"/>
                    </div>
                </div>
                <div class="skill-row-2">
                    <div class="flewrow skill-level">
                        <label class="skill-level-label">{{skill.level}}</label>
                    </div>
                    <div class="flewrow">
                        <label class="skill-progression-label">{{skill.progression}}</label>
                    </div>
                </div>
            </li>
            {{/each}}
            </ul>
        </div>
    </div>
    <!-- END NEW-->

    <input type="hidden" id="spl">
    <input type="hidden" id="spl-base">
    <input type="hidden" id="wspl">
    <input type="hidden" id="wspl-base">
    <input type="hidden" id="usedSkillpoints">
    <input type="hidden" id="usedWeaponSkillpoints">
    <input type="hidden" id="hd">
  <button type="submit" name="submit" value="1"><i class="far fa-save"></i> {{localize "D35E.SetLevelData"}}</button>

    <script>
        function selectedClassData(select, force = false) {
            var hd = parseInt($('option:selected', select).attr('data-hd'));
            var skills = parseInt($('option:selected', select).attr('data-skill'));
            var weaponSkills = parseInt($('option:selected', select).attr('data-weaponskill'));
            $('#spl-base').val(skills)
            $('#wspl-base').val(weaponSkills)
            $('#hd').val(hd)
            let classId = $('option:selected', select).val();
            let intSkills = {{actor.data.abilities.int.mod}};
            let bonusSkillPoints = '{{bonusSkillPoints}}';
            skills += intSkills
            skills += parseInt(bonusSkillPoints)
            weaponSkills += parseInt(bonusSkillPoints)
            skills = Math.max(1,skills)
            weaponSkills = Math.max(1,weaponSkills)
            let classes = JSON.parse('{{{classesJson}}}')
            let classSkills = classes.find(_c => _c.id === classId).classSkills;
            let weaponClasses = JSON.parse('{{{weaponClassesJson}}}')
            let classWeaponSkills = weaponClasses.find(_c => _c.id === classId).classWeaponSkills;
            for (let key of Object.keys(classSkills)) {
                $(`input[data-class-skillid='${key}'`).val(classSkills[key])
                $(`span[data-class-skillid='${key}'`).toggleClass("bold", classSkills[key])
            }
            for (let key of Object.keys(classWeaponSkills)) {
                $(`input[data-class-skillid='${key}'`).val(classWeaponSkills[key])
                $(`span[data-class-skillid='${key}'`).toggleClass("bold", classWeaponSkills[key])
            }
            let level = {{level}};
            let isCharacter = '{{actor.type}}' === "character";
            if (level === 1 && isCharacter) {
                skills = skills * 4
                weaponSkills = weaponSkills * 4
            }

            $('#spl').val(skills)
            $('#wspl').val(weaponSkills)
            
            if (!force) $('#usedSkillpoints').val(0)
            if (!force) $('#usedWeaponSkillpoints').val(0)
            if (!force) $('.skill-value').val(0)
            if (!force) $('.weaponskill-value').val(0)
            if (!force) rollHP();
            
            updateFormData()
        }

        function updateFormData() {
            let usedSkillpoints = parseInt($('#usedSkillpoints').val() || 0)
            let usedWeaponSkillpoints = parseInt($('#usedWeaponSkillpoints').val() || 0)
            let spl = parseInt($('#spl').val() || 0)
            let splBase = parseInt($('#spl-base').val() || 0)
            let wspl = parseInt($('#wspl').val() || 0)
            let wsplBase = parseInt($('#wspl-base').val() || 0)
            let hd = parseInt($('#hd').val() || 0)
            $('.skill').each(function( index ) {
                let val = parseInt($(this).find('.skill-value').val() || 0)
                let baseRank = parseInt($(this).find('.original-skill-value').val() || 0)
                let skillClass = $(this).find('.skill-class').val() === "true";
                if (val === 0) {
                    $(this).find('.remove-skill').css('opacity',0.2);
                    $(this).find('.remove-skill').parent().css('cursor','default');
                } else {
                    $(this).find('.remove-skill').css('opacity',0.8);
                    $(this).find('.remove-skill').parent().css('cursor','pointer');
                }

                let newVal = baseRank + val;
                if (newVal >= 20) {
                    $(this).find('.add-skill').css('opacity',0.2);
                    $(this).find('.add-skill').parent().css('cursor','default');
                } else {
                    $(this).find('.add-skill').css('opacity',0.8);
                    $(this).find('.add-skill').parent().css('cursor','pointer');
                }
                
                $(this).find('.combined-skill-value').val(baseRank + val*(skillClass ? 1.0 : 0.5))
                
                if (newVal > {{totalLevel}} + 3) {
                    $(this).find('.combined-skill-value').css('color','darkred')
                } else {
                    $(this).find('.combined-skill-value').css('color','black')
                }

                let NCL = baseRank + val*(skillClass ? 1.0 : 0.5);
                // NEW
                let newLevel = '';
                if(NCL < 2) { newLevel = '' } 
                else if(NCL < 5) { newLevel = 'E' } 
                else if(NCL < 9) { newLevel = 'D' }
                else if(NCL < 14) { newLevel = 'C' } 
                else if(NCL < 20) { newLevel = 'B' }
                else newLevel = 'A'

                let newProgression = '';
                if (NCL < 1) { newProgression = '◻' }
                else if(NCL < 2) { newProgression = '◼' } 
                else if(NCL < 3) { newProgression = '◻◻' } 
                else if(NCL < 4) { newProgression = '◼◻' }
                else if(NCL < 5) { newProgression = '◼◼' }
                else if(NCL < 6) { newProgression = '◻◻◻' }
                else if(NCL < 7) { newProgression = '◼◻◻' }
                else if(NCL < 8) { newProgression = '◼◼◻' }
                else if(NCL < 9) { newProgression = '◼◼◼' }
                else if(NCL < 10) { newProgression = '◻◻◻◻' }
                else if(NCL < 11) { newProgression = '◼◻◻◻' }
                else if(NCL < 12) { newProgression = '◼◼◻◻' }
                else if(NCL < 13) { newProgression = '◼◼◼◻' }
                else if(NCL < 14) { newProgression = '◼◼◼◼' }
                else if(NCL < 15) { newProgression = '◻◻◻◻◻' }
                else if(NCL < 16) { newProgression = '◼◻◻◻◻' }
                else if(NCL < 17) { newProgression = '◼◼◻◻◻' }
                else if(NCL < 18) { newProgression = '◼◼◼◻◻' }
                else if(NCL < 19) { newProgression = '◼◼◼◼◻' }
                else if(NCL < 20) { newProgression = '◼◼◼◼◼' }
                else if(NCL < 21) { newProgression = '' }

                $(this).find('.skill-level-label').text(newLevel);
                $(this).find('.skill-progression-label').text(newProgression);
                // END NEW
            });

            if (usedSkillpoints > spl) {
                $('#skill-used').css('color','darkred')
            } else {
                $('#skill-used').css('color','black')
            }
            if (usedWeaponSkillpoints > wspl) {
                $('#weaponskill-used').css('color','darkred')
            } else {
                $('#weaponskill-used').css('color','black')
            }
            let intSkills = '{{actor.data.abilities.int.mod}}';
            let bonusSkillPoints = '{{bonusSkillPoints}}';
            let level = {{level}};
            if (level === 1) {
                $('#flb').text(', {{localize "D35E.FirstLevelMultiplier"}}')
                $('#flb2').text(', {{localize "D35E.FirstLevelMultiplier"}}')
            }
            $('#skill-per-level-base').text(splBase)
            $('#skill-per-level-int').text(intSkills)
            $('#skill-per-level-bonus').text(bonusSkillPoints)
            $('#skill-per-level').text(spl)
            $('#skill-used').text(`${usedSkillpoints} / ${spl}`)
            $('#weaponskill-per-level-base').text(wsplBase)
            $('#weaponskill-per-level-int').text(intSkills)
            $('#weaponskill-per-level-bonus').text(bonusSkillPoints)
            $('#weaponskill-per-level').text(wspl)
            $('#weaponskill-used').text(`${usedWeaponSkillpoints} / ${wspl}`)
            $('#class-hd').text(`${hd}`)
        }

        function addRemoveSkill(id, combinedId, value, classSkill) {
            let usedSkillpoints = parseInt($('#usedSkillpoints').val() || 0)
            let spl = parseInt($('#spl').val() || 0)
            if (usedSkillpoints + value < 0) return;
            if (parseInt($(`input[name='${id}']`).val() || 0) + value < 0) return;
            // NEW
            if (parseInt($(`input[name='${combinedId}']`).val() || 0) + value > 20) return;
            // END NEW
            $(`input[name='${id}']`).val(parseInt($(`input[name='${id}']`).val() || 0) + value)
            usedSkillpoints+=value;
            $('#usedSkillpoints').val(usedSkillpoints)
            updateFormData();
        }

        function addRemoveWeaponSkill(id, combinedId, value, classSkill) {
            let usedWeaponSkillpoints = parseInt($('#usedWeaponSkillpoints').val() || 0)
            let wspl = parseInt($('#wspl').val() || 0)
            if (usedWeaponSkillpoints + value < 0) return;
            if (parseInt($(`input[name='${id}']`).val() || 0) + value < 0) return;
            // NEW
            if (parseInt($(`input[name='${combinedId}']`).val() || 0) + value > 20) return;
            // END NEW
            $(`input[name='${id}']`).val(parseInt($(`input[name='${id}']`).val() || 0) + value)
            usedWeaponSkillpoints+=value;
            $('#usedWeaponSkillpoints').val(usedWeaponSkillpoints)
            updateFormData();
        }

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }

        function rollHP() {
            let hd = parseInt($('#hd').val() || 0)
            let level = {{level}};
            let isCharacter = '{{actor.type}}' === "character";
            if (level === 1 && isCharacter)
                $('#hp-input').val(hd)
            else {
                $('#hp-input').val(getRandomInt(1, hd))
            }
        }

        {
            let maxSkillVal = 0
            $('.skillCount').each(function (index) {
                let val = parseInt($(this).find('input').val() || 0)
                maxSkillVal += val;
            })
            let maxWeaponSkillVal = 0
            $('.weaponskillCount').each(function (index) {
                let val = parseInt($(this).find('input').val() || 0)
                maxWeaponSkillVal += val;
            })
            $('#usedSkillpoints').val(maxSkillVal)
            $('#usedWeaponSkillpoints').val(maxWeaponSkillVal)
        }

        selectedClassData($('#class-select'), true);
        updateFormData();


    </script>
</form>
